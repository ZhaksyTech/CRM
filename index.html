<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zhaksytech Mini CRM</title>
    <!-- Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the Inter font and overall body background */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for better content visibility */
            padding: 20px;
            box-sizing: border-box;
        }
        /* Container styling */
        .container {
            max-width: 1200px;
            width: 100%;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        /* Header styling */
        .header {
            background: linear-gradient(135deg, #4F81BD, #365F91);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 700;
        }
        .header p {
            margin: 10px 0 0 0;
            font-size: 1.2em;
            opacity: 0.9;
        }
        /* Tabs styling */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* For smooth scrolling on iOS */
        }
        .tab {
            padding: 15px 20px;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            transition: all 0.3s ease;
            white-space: nowrap;
            border-radius: 8px 8px 0 0; /* Rounded top corners */
        }
        .tab:hover {
            background: #e9ecef;
        }
        .tab.active {
            background: white;
            color: #4F81BD;
            border-bottom: 3px solid #4F81BD;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05); /* Subtle shadow for active tab */
        }
        /* Content area styling */
        .content {
            padding: 30px;
        }
        .sheet {
            display: none;
        }
        .sheet.active {
            display: block;
        }
        /* Form styling */
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #343a40;
        }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="date"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        .form-group input[type="text"]:focus,
        .form-group input[type="email"]:focus,
        .form-group input[type="date"]:focus,
        .form-group input[type="number"]:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4F81BD;
            box-shadow: 0 0 0 0.2rem rgba(79, 129, 189, 0.25);
        }
        .btn-primary {
            background: #4F81BD;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-primary:hover {
            background: #365F91;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-left: 5px;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-left: 5px;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        /* Table styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        th {
            background: linear-gradient(135deg, #4F81BD, #365F91);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        td {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            vertical-align: top;
            line-height: 1.5;
        }
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        tr:hover {
            background: #e3f2fd;
        }
        /* Card styling for better mobile view of lists */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .card {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            padding: 20px;
            border: 1px solid #e0e0e0;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }
        .card h3 {
            font-size: 1.25em;
            color: #4F81BD;
            margin-bottom: 10px;
        }
        .card p {
            font-size: 0.95em;
            color: #555;
            margin-bottom: 8px;
        }
        .card .actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap; /* Allow buttons to wrap on small screens */
        }
        .card .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            margin-top: 5px;
        }
        .status-lead { background-color: #ffe0b2; color: #fb8c00; } /* Orange */
        .status-prospect { background-color: #bbdefb; color: #2196f3; } /* Blue */
        .status-client { background-color: #c8e6c9; color: #43a047; } /* Green */
        .status-lost { background-color: #ffcdd2; color: #e53935; } /* Red */
        .status-new { background-color: #e0e0e0; color: #616161; } /* Grey */
        .status-in-progress { background-color: #fff9c4; color: #fbc02d; } /* Yellow */
        .status-completed { background-color: #c8e6c9; color: #43a047; } /* Green */
        .status-on-hold { background-color: #cfd8dc; color: #546e7a; } /* Blue-grey */
        .status-sent { background-color: #bbdefb; color: #2196f3; } /* Blue */
        .status-accepted { background-color: #c8e6c9; color: #43a047; } /* Green */
        .status-rejected { background-color: #ffcdd2; color: #e53935; } /* Red */

        /* Message box styling */
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4F81BD;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .message-box.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Modal styling */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 600px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            position: relative;
        }
        .modal.show .modal-content {
            transform: scale(1);
        }
        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }
        .modal-close-btn:hover {
            color: #333;
        }

        /* Template box styling */
        .template-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            position: relative;
        }
        .template-box h3 {
            margin: 0 0 15px 0;
            color: #4F81BD;
            font-size: 1.2em;
        }
        .copy-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #4F81BD;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        .copy-btn:hover {
            background: #365F91;
            transform: translateY(-2px);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            .header p {
                font-size: 1em;
            }
            .tabs {
                flex-wrap: wrap;
                justify-content: center;
            }
            .tab {
                flex-grow: 1;
                text-align: center;
                margin: 5px;
                border-radius: 8px;
            }
            .tab.active {
                border-bottom: none;
            }
            .content {
                padding: 20px;
            }
            .card-grid {
                grid-template-columns: 1fr; /* Stack cards on small screens */
            }
            .modal-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Zhaksytech Mini CRM</h1>
            <p>Manage your clients, projects, and outreach with ease</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showSheet('clients')">üë• Clients</button>
            <button class="tab" onclick="showSheet('projects')">üìä Projects</button>
            <button class="tab" onclick="showSheet('proposals')">üìÑ Proposals</button>
            <button class="tab" onclick="showSheet('templates')">üìù Templates</button>
        </div>

        <div class="content">
            <!-- Clients Sheet -->
            <div id="clients" class="sheet active">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Client Management</h2>
                <button class="btn-primary mb-6" onclick="openClientModal()">‚ûï Add New Client</button>

                <div id="clients-list" class="card-grid">
                    <!-- Client cards will be rendered here by JavaScript -->
                    <p class="text-gray-600" id="no-clients-message">No clients added yet. Click "Add New Client" to get started!</p>
                </div>
            </div>

            <!-- Projects Sheet -->
            <div id="projects" class="sheet">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Project Management</h2>
                <button class="btn-primary mb-6" onclick="openProjectModal()">‚ûï Add New Project</button>

                <div id="projects-list" class="card-grid">
                    <!-- Project cards will be rendered here by JavaScript -->
                    <p class="text-gray-600" id="no-projects-message">No projects added yet. Click "Add New Project" to get started!</p>
                </div>
            </div>

            <!-- Proposals Sheet -->
            <div id="proposals" class="sheet">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Proposal Tracking</h2>
                <button class="btn-primary mb-6" onclick="openProposalModal()">‚ûï Add New Proposal</button>

                <div id="proposals-list" class="card-grid">
                    <!-- Proposal cards will be rendered here by JavaScript -->
                    <p class="text-gray-600" id="no-proposals-message">No proposals added yet. Click "Add New Proposal" to get started!</p>
                </div>
            </div>

            <!-- Templates Sheet -->
            <div id="templates" class="sheet">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Marketing & Outreach Templates</h2>
                <button class="btn-primary mb-6" onclick="openTemplateModal()">‚ûï Add New Template</button>

                <div id="templates-list">
                    <!-- Templates will be rendered here by JavaScript -->
                    <p class="text-gray-600" id="no-templates-message">No custom templates added yet. Click "Add New Template" to get started!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals for Add/Edit -->

    <!-- Client Modal -->
    <div id="client-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('client-modal')">&times;</button>
            <h2 id="client-modal-title" class="text-xl font-bold mb-4 text-gray-800">Add New Client</h2>
            <form id="client-form">
                <input type="hidden" id="client-id">
                <div class="form-group">
                    <label for="client-name">Client Name:</label>
                    <input type="text" id="client-name" placeholder="e.g., Tech Solutions Inc." required>
                </div>
                <div class="form-group">
                    <label for="client-contact">Contact Person/Info:</label>
                    <input type="text" id="client-contact" placeholder="e.g., John Doe, +77011234567, @johndoe_tg" required>
                </div>
                <div class="form-group">
                    <label for="client-company">Company (Optional):</label>
                    <input type="text" id="client-company" placeholder="e.g., Innovate Corp.">
                </div>
                <div class="form-group">
                    <label for="client-status">Status:</label>
                    <select id="client-status" required>
                        <option value="Lead">Lead</option>
                        <option value="Prospect">Prospect</option>
                        <option value="Client">Client</option>
                        <option value="Lost">Lost</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="client-notes">Notes:</label>
                    <textarea id="client-notes" rows="3" placeholder="Any relevant details about the client..."></textarea>
                </div>
                <button type="submit" class="btn-primary w-full">Save Client</button>
            </form>

            <h3 class="text-lg font-bold mt-6 mb-3 text-gray-800">Interaction Log</h3>
            <div id="interaction-log-display">
                <p class="text-gray-600" id="no-interactions-message">No interactions logged yet.</p>
            </div>
            <button class="btn-secondary mt-4" onclick="openInteractionModal()">‚ûï Log New Interaction</button>
        </div>
    </div>

    <!-- Interaction Modal (nested within Client Modal's context) -->
    <div id="interaction-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('interaction-modal')">&times;</button>
            <h2 class="text-xl font-bold mb-4 text-gray-800">Log Interaction for <span id="interaction-client-name"></span></h2>
            <form id="interaction-form">
                <input type="hidden" id="interaction-client-id">
                <div class="form-group">
                    <label for="interaction-date">Date:</label>
                    <input type="date" id="interaction-date" required>
                </div>
                <div class="form-group">
                    <label for="interaction-type">Type:</label>
                    <select id="interaction-type" required>
                        <option value="Call">Call</option>
                        <option value="Email">Email</option>
                        <option value="Telegram">Telegram Message</option>
                        <option value="Meeting">Meeting</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="interaction-summary">Summary:</label>
                    <textarea id="interaction-summary" rows="4" placeholder="Brief summary of the interaction..." required></textarea>
                </div>
                <button type="submit" class="btn-primary w-full">Save Interaction</button>
            </form>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="project-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('project-modal')">&times;</button>
            <h2 id="project-modal-title" class="text-xl font-bold mb-4 text-gray-800">Add New Project</h2>
            <form id="project-form">
                <input type="hidden" id="project-id">
                <div class="form-group">
                    <label for="project-name">Project Name:</label>
                    <input type="text" id="project-name" placeholder="e.g., E-commerce Telegram Bot" required>
                </div>
                <div class="form-group">
                    <label for="project-client">Associated Client:</label>
                    <select id="project-client" required>
                        <!-- Clients will be loaded here by JS -->
                        <option value="">Select a Client</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="project-service-type">Service Type:</label>
                    <select id="project-service-type" required>
                        <option value="Telegram Bot">Telegram Bot</option>
                        <option value="Web App">Web App</option>
                        <option value="Mobile App">Mobile App</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="project-status">Status:</label>
                    <select id="project-status" required>
                        <option value="New">New</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Completed">Completed</option>
                        <option value="On Hold">On Hold</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="project-price">Estimated Price (USD):</label>
                    <input type="number" id="project-price" placeholder="e.g., 500" min="0">
                </div>
                <div class="form-group">
                    <label for="project-due-date">Due Date (Optional):</label>
                    <input type="date" id="project-due-date">
                </div>
                <div class="form-group">
                    <label for="project-notes">Notes:</label>
                    <textarea id="project-notes" rows="3" placeholder="Project requirements, key features, etc."></textarea>
                </div>
                <button type="submit" class="btn-primary w-full">Save Project</button>
            </form>
        </div>
    </div>

    <!-- Proposal Modal -->
    <div id="proposal-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('proposal-modal')">&times;</button>
            <h2 id="proposal-modal-title" class="text-xl font-bold mb-4 text-gray-800">Add New Proposal</h2>
            <form id="proposal-form">
                <input type="hidden" id="proposal-id">
                <div class="form-group">
                    <label for="proposal-name">Proposal Title:</label>
                    <input type="text" id="proposal-name" placeholder="e.g., Proposal for CRM Integration Bot" required>
                </div>
                <div class="form-group">
                    <label for="proposal-client">Client:</label>
                    <select id="proposal-client" required>
                        <!-- Clients will be loaded here by JS -->
                        <option value="">Select a Client</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="proposal-project">Associated Project (Optional):</label>
                    <select id="proposal-project">
                        <!-- Projects will be loaded here by JS -->
                        <option value="">Select a Project</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="proposal-status">Status:</label>
                    <select id="proposal-status" required>
                        <option value="Draft">Draft</option>
                        <option value="Sent">Sent</option>
                        <option value="Accepted">Accepted</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="proposal-date-sent">Date Sent (Optional):</label>
                    <input type="date" id="proposal-date-sent">
                </div>
                <div class="form-group">
                    <label for="proposal-price">Proposed Price (USD):</label>
                    <input type="number" id="proposal-price" placeholder="e.g., 750" min="0" required>
                </div>
                <div class="form-group">
                    <label for="proposal-link">Link to Proposal (Optional):</label>
                    <input type="text" id="proposal-link" placeholder="e.g., https://docs.google.com/document/d/xyz">
                </div>
                <button type="submit" class="btn-primary w-full">Save Proposal</button>
            </form>
        </div>
    </div>

    <!-- Template Modal -->
    <div id="template-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('template-modal')">&times;</button>
            <h2 id="template-modal-title" class="text-xl font-bold mb-4 text-gray-800">Add New Template</h2>
            <form id="template-form">
                <input type="hidden" id="template-id">
                <div class="form-group">
                    <label for="template-name">Template Name:</label>
                    <input type="text" id="template-name" placeholder="e.g., Cold Outreach Email" required>
                </div>
                <div class="form-group">
                    <label for="template-content">Content:</label>
                    <textarea id="template-content" rows="10" placeholder="Paste your template content here..." required></textarea>
                </div>
                <button type="submit" class="btn-primary w-full">Save Template</button>
            </form>
        </div>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="message-box"></div>

    <script>
        // --- Data Management (Local Storage) ---
        let clients = [];
        let projects = [];
        let proposals = [];
        let templates = [];

        // Pre-defined templates from user's original request
        const predefinedTemplates = [
            { id: 'linkedin-headline', name: 'LinkedIn Headline', content: 'üöÄ Telegram Bot, Web App & Mobile App Developer | Helping CIS Businesses Automate & Grow | Founder of Zhaksytech' },
            { id: 'linkedin-about', name: 'LinkedIn About Section', content: 'Hi, I\'m Maksat Zhaksybaev, founder of Zhaksytech.\n\nWe specialize in building smart Telegram bots, web applications, and mobile apps that help small and mid-sized businesses across the CIS automate operations, attract more clients, and scale fast ‚Äî without breaking the bank.\n\nWhat makes us different?\n‚úÖ We\'re fast\n‚úÖ We\'re local \n‚úÖ We care about real results, not just code\n\nLet\'s connect if you need a bot that works like a business partner, a web app that drives sales, or a mobile app that engages customers.\n\nüì© DM me or reach out: [@zhaksy_tech on Telegram]' },
            { id: 'uvp', name: 'Unique Value Proposition (UVP)', content: 'Zhaksytech builds smart, reliable Telegram bots, web applications, and mobile apps for businesses in the CIS. We automate your sales, support, and operations ‚Äî fast, affordable, and backed by local tech experts you can trust.' },
            { id: 'telegram-cold', name: 'Telegram Outreach Message 1 (Cold)', content: 'Hi! üëã \nI noticed your business and thought I\'d reach out.\n\nI build smart Telegram bots, web apps, and mobile apps that help automate sales, support, and customer communication. If you\'re ever interested in using technology to save time or boost revenue, I\'d be happy to show you a demo.\n\nNo pressure ‚Äî just let me know üòä \nMaksat from Zhaksytech | @zhaksy_tech' },
            { id: 'telegram-followup', name: 'Telegram Outreach Message 2 (Follow-up)', content: 'Hey again! Just dropping this here ‚Äî if you\'re ever curious how a bot, web app, or mobile solution could help your business, I\'d love to chat.\n\nWe\'ve built Telegram bots for sales, web platforms for marketplaces, mobile apps for customer engagement, and more.\n\nFree consultation if you want to explore üí°' },
            { id: 'linkedin-connect', name: 'LinkedIn Connection Request', content: 'Hi [Name]! I help CIS businesses automate operations with custom Telegram bots, web apps, and mobile solutions. Would love to connect and share ideas about business automation!' },
            { id: 'proposal-template', name: 'Client Proposal Format', content: 'üìÑ Proposal for [Service Type] Development\n\nüë§ Client Name: [Insert] \nüìÖ Date: [Insert]\n\nüîß Project Goal: \n[Describe what the client wants ‚Äî e.g., automate orders, sales bot, booking system, e-commerce platform, customer app]\n\n‚úÖ Solution: \nZhaksytech will develop a custom [Telegram bot/Web app/Mobile app] including:\n- [List features: forms, payment system, admin panel, etc.]\n- Language: [Russian/Kazakh/English]\n- Timeline: [e.g., 5-15 days depending on complexity]\n- Support: 1 week of post-launch support\n\nüí∞ Price: \n[Insert based on package or scope]\n\nüìû Contact: \n@zhaksy_tech | zhaksytech@gmail.com\n\nThank you for choosing Zhaksytech üöÄ' }
        ];

        // Function to load data from local storage
        function loadData() {
            clients = JSON.parse(localStorage.getItem('crmClients')) || [];
            projects = JSON.parse(localStorage.getItem('crmProjects')) || [];
            proposals = JSON.parse(localStorage.getItem('crmProposals')) || [];
            // Load custom templates, then combine with predefined ones
            const customTemplates = JSON.parse(localStorage.getItem('crmTemplates')) || [];
            templates = [...predefinedTemplates, ...customTemplates];
        }

        // Function to save data to local storage
        function saveData() {
            localStorage.setItem('crmClients', JSON.stringify(clients));
            localStorage.setItem('crmProjects', JSON.stringify(projects));
            localStorage.setItem('crmProposals', JSON.stringify(proposals));
            // Save only custom templates, predefined are constant
            const customTemplates = templates.filter(t => !predefinedTemplates.some(pt => pt.id === t.id));
            localStorage.setItem('crmTemplates', JSON.stringify(customTemplates));
        }

        // --- UI Functions ---

        // Show/Hide Sheets (Tabs)
        function showSheet(sheetName) {
            document.querySelectorAll('.sheet').forEach(sheet => sheet.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));

            document.getElementById(sheetName).classList.add('active');
            document.querySelector(`.tab[onclick="showSheet('${sheetName}')"]`).classList.add('active');

            // Render content for the active sheet
            if (sheetName === 'clients') renderClients();
            else if (sheetName === 'projects') renderProjects();
            else if (sheetName === 'proposals') renderProposals();
            else if (sheetName === 'templates') renderTemplates();
        }

        // Show a temporary message box
        function showMessage(message, type = 'success') {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = message;
            msgBox.className = 'message-box show'; // Reset classes and show
            if (type === 'error') {
                msgBox.style.backgroundColor = '#dc3545'; // Red for error
            } else {
                msgBox.style.backgroundColor = '#4F81BD'; // Blue for success
            }
            setTimeout(() => {
                msgBox.classList.remove('show');
            }, 3000);
        }

        // Open/Close Modals
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            // Reset forms when closing modals
            if (modalId === 'client-modal') document.getElementById('client-form').reset();
            if (modalId === 'project-modal') document.getElementById('project-form').reset();
            if (modalId === 'proposal-modal') document.getElementById('proposal-form').reset();
            if (modalId === 'template-modal') document.getElementById('template-form').reset();
        }

        // --- Client Management ---

        function renderClients() {
            const clientsList = document.getElementById('clients-list');
            clientsList.innerHTML = ''; // Clear existing cards

            if (clients.length === 0) {
                clientsList.innerHTML = '<p class="text-gray-600" id="no-clients-message">No clients added yet. Click "Add New Client" to get started!</p>';
                return;
            }

            clients.forEach(client => {
                const clientCard = document.createElement('div');
                clientCard.className = 'card';
                clientCard.innerHTML = `
                    <h3 class="font-bold">${client.name}</h3>
                    <p class="text-gray-700"><strong>Contact:</strong> ${client.contact}</p>
                    ${client.company ? `<p class="text-gray-700"><strong>Company:</strong> ${client.company}</p>` : ''}
                    <p class="text-gray-700"><strong>Status:</strong> <span class="status-badge status-${client.status.toLowerCase().replace(' ', '-')}">${client.status}</span></p>
                    ${client.notes ? `<p class="text-gray-700"><strong>Notes:</strong> ${client.notes}</p>` : ''}
                    <div class="actions">
                        <button class="btn-secondary" onclick="editClient('${client.id}')">Edit</button>
                        <button class="btn-danger" onclick="deleteClient('${client.id}')">Delete</button>
                        <button class="btn-secondary" onclick="openInteractionModalForClient('${client.id}', '${client.name}')">Log Interaction</button>
                    </div>
                `;
                clientsList.appendChild(clientCard);
            });
        }

        function openClientModal(clientId = '') {
            const modal = document.getElementById('client-modal');
            const form = document.getElementById('client-form');
            const title = document.getElementById('client-modal-title');
            const clientIdField = document.getElementById('client-id');
            const clientNameField = document.getElementById('client-name');
            const clientContactField = document.getElementById('client-contact');
            const clientCompanyField = document.getElementById('client-company');
            const clientStatusField = document.getElementById('client-status');
            const clientNotesField = document.getElementById('client-notes');
            const interactionLogDisplay = document.getElementById('interaction-log-display');

            form.reset(); // Clear form

            if (clientId) {
                // Edit existing client
                const client = clients.find(c => c.id === clientId);
                if (client) {
                    title.textContent = 'Edit Client';
                    clientIdField.value = client.id;
                    clientNameField.value = client.name;
                    clientContactField.value = client.contact;
                    clientCompanyField.value = client.company;
                    clientStatusField.value = client.status;
                    clientNotesField.value = client.notes;

                    // Render interactions for this client
                    renderInteractions(client.id);
                }
            } else {
                // Add new client
                title.textContent = 'Add New Client';
                clientIdField.value = '';
                interactionLogDisplay.innerHTML = '<p class="text-gray-600" id="no-interactions-message">No interactions logged yet.</p>';
            }
            openModal('client-modal');
        }

        document.getElementById('client-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const id = document.getElementById('client-id').value;
            const name = document.getElementById('client-name').value;
            const contact = document.getElementById('client-contact').value;
            const company = document.getElementById('client-company').value;
            const status = document.getElementById('client-status').value;
            const notes = document.getElementById('client-notes').value;

            if (id) {
                // Update existing client
                const clientIndex = clients.findIndex(c => c.id === id);
                if (clientIndex > -1) {
                    clients[clientIndex] = { ...clients[clientIndex], name, contact, company, status, notes };
                    showMessage('Client updated successfully!');
                }
            } else {
                // Add new client
                const newClient = {
                    id: crypto.randomUUID(),
                    name,
                    contact,
                    company,
                    status,
                    notes,
                    interactions: [] // Initialize interactions array
                };
                clients.push(newClient);
                showMessage('Client added successfully!');
            }
            saveData();
            renderClients();
            closeModal('client-modal');
        });

        function editClient(clientId) {
            openClientModal(clientId);
        }

        function deleteClient(clientId) {
            if (confirm('Are you sure you want to delete this client and all associated projects/proposals?')) {
                clients = clients.filter(c => c.id !== clientId);
                // Also delete associated projects and proposals
                projects = projects.filter(p => p.clientId !== clientId);
                proposals = proposals.filter(pr => pr.clientId !== clientId);
                saveData();
                renderClients();
                renderProjects(); // Re-render projects as some might be deleted
                renderProposals(); // Re-render proposals as some might be deleted
                showMessage('Client deleted successfully!', 'error');
            }
        }

        // --- Interaction Logging ---

        let currentClientIdForInteraction = null; // To store which client is being interacted with

        function openInteractionModalForClient(clientId, clientName) {
            currentClientIdForInteraction = clientId;
            document.getElementById('interaction-client-id').value = clientId;
            document.getElementById('interaction-client-name').textContent = clientName;
            document.getElementById('interaction-form').reset();
            openModal('interaction-modal');
        }

        document.getElementById('interaction-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const clientId = document.getElementById('interaction-client-id').value;
            const date = document.getElementById('interaction-date').value;
            const type = document.getElementById('interaction-type').value;
            const summary = document.getElementById('interaction-summary').value;

            const client = clients.find(c => c.id === clientId);
            if (client) {
                if (!client.interactions) {
                    client.interactions = []; // Ensure interactions array exists
                }
                client.interactions.push({
                    id: crypto.randomUUID(),
                    date,
                    type,
                    summary
                });
                saveData();
                renderInteractions(clientId); // Re-render interactions for the current client
                showMessage('Interaction logged successfully!');
                closeModal('interaction-modal');
            } else {
                showMessage('Error: Client not found.', 'error');
            }
        });

        function renderInteractions(clientId) {
            const interactionLogDisplay = document.getElementById('interaction-log-display');
            interactionLogDisplay.innerHTML = '';
            const client = clients.find(c => c.id === clientId);

            if (client && client.interactions && client.interactions.length > 0) {
                // Sort interactions by date, newest first
                const sortedInteractions = [...client.interactions].sort((a, b) => new Date(b.date) - new Date(a.date));

                sortedInteractions.forEach(interaction => {
                    const interactionDiv = document.createElement('div');
                    interactionDiv.className = 'bg-gray-50 p-3 rounded-lg mb-2 border border-gray-200';
                    interactionDiv.innerHTML = `
                        <p class="text-sm text-gray-800"><strong>Date:</strong> ${interaction.date}</p>
                        <p class="text-sm text-gray-800"><strong>Type:</strong> ${interaction.type}</p>
                        <p class="text-sm text-gray-800"><strong>Summary:</strong> ${interaction.summary}</p>
                        <button class="btn-danger btn-sm mt-2" onclick="deleteInteraction('${clientId}', '${interaction.id}')">Delete</button>
                    `;
                    interactionLogDisplay.appendChild(interactionDiv);
                });
            } else {
                interactionLogDisplay.innerHTML = '<p class="text-gray-600" id="no-interactions-message">No interactions logged yet.</p>';
            }
        }

        function deleteInteraction(clientId, interactionId) {
            if (confirm('Are you sure you want to delete this interaction?')) {
                const client = clients.find(c => c.id === clientId);
                if (client && client.interactions) {
                    client.interactions = client.interactions.filter(i => i.id !== interactionId);
                    saveData();
                    renderInteractions(clientId);
                    showMessage('Interaction deleted successfully!', 'error');
                }
            }
        }

        // --- Project Management ---

        function renderProjects() {
            const projectsList = document.getElementById('projects-list');
            projectsList.innerHTML = '';

            if (projects.length === 0) {
                projectsList.innerHTML = '<p class="text-gray-600" id="no-projects-message">No projects added yet. Click "Add New Project" to get started!</p>';
                return;
            }

            projects.forEach(project => {
                const client = clients.find(c => c.id === project.clientId);
                const clientName = client ? client.name : 'N/A (Client Deleted)';
                const projectCard = document.createElement('div');
                projectCard.className = 'card';
                projectCard.innerHTML = `
                    <h3 class="font-bold">${project.name}</h3>
                    <p class="text-gray-700"><strong>Client:</strong> ${clientName}</p>
                    <p class="text-gray-700"><strong>Service:</strong> ${project.serviceType}</p>
                    <p class="text-gray-700"><strong>Status:</strong> <span class="status-badge status-${project.status.toLowerCase().replace(' ', '-')}">${project.status}</span></p>
                    ${project.price ? `<p class="text-gray-700"><strong>Price:</strong> $${project.price}</p>` : ''}
                    ${project.dueDate ? `<p class="text-gray-700"><strong>Due Date:</strong> ${project.dueDate}</p>` : ''}
                    ${project.notes ? `<p class="text-gray-700"><strong>Notes:</strong> ${project.notes}</p>` : ''}
                    <div class="actions">
                        <button class="btn-secondary" onclick="editProject('${project.id}')">Edit</button>
                        <button class="btn-danger" onclick="deleteProject('${project.id}')">Delete</button>
                    </div>
                `;
                projectsList.appendChild(projectCard);
            });
        }

        function populateClientDropdowns(selectElementId) {
            const select = document.getElementById(selectElementId);
            select.innerHTML = '<option value="">Select a Client</option>'; // Default option
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                select.appendChild(option);
            });
        }

        function populateProjectDropdowns(selectElementId) {
            const select = document.getElementById(selectElementId);
            select.innerHTML = '<option value="">Select a Project</option>'; // Default option
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                select.appendChild(option);
            });
        }

        function openProjectModal(projectId = '') {
            const modal = document.getElementById('project-modal');
            const form = document.getElementById('project-form');
            const title = document.getElementById('project-modal-title');
            const projectIdField = document.getElementById('project-id');
            const projectNameField = document.getElementById('project-name');
            const projectClientField = document.getElementById('project-client');
            const projectServiceTypeField = document.getElementById('project-service-type');
            const projectStatusField = document.getElementById('project-status');
            const projectPriceField = document.getElementById('project-price');
            const projectDueDateField = document.getElementById('project-due-date');
            const projectNotesField = document.getElementById('project-notes');

            form.reset();
            populateClientDropdowns('project-client'); // Populate client dropdown

            if (projectId) {
                const project = projects.find(p => p.id === projectId);
                if (project) {
                    title.textContent = 'Edit Project';
                    projectIdField.value = project.id;
                    projectNameField.value = project.name;
                    projectClientField.value = project.clientId;
                    projectServiceTypeField.value = project.serviceType;
                    projectStatusField.value = project.status;
                    projectPriceField.value = project.price;
                    projectDueDateField.value = project.dueDate;
                    projectNotesField.value = project.notes;
                }
            } else {
                title.textContent = 'Add New Project';
                projectIdField.value = '';
            }
            openModal('project-modal');
        }

        document.getElementById('project-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const id = document.getElementById('project-id').value;
            const name = document.getElementById('project-name').value;
            const clientId = document.getElementById('project-client').value;
            const serviceType = document.getElementById('project-service-type').value;
            const status = document.getElementById('project-status').value;
            const price = document.getElementById('project-price').value;
            const dueDate = document.getElementById('project-due-date').value;
            const notes = document.getElementById('project-notes').value;

            if (id) {
                const projectIndex = projects.findIndex(p => p.id === id);
                if (projectIndex > -1) {
                    projects[projectIndex] = { ...projects[projectIndex], name, clientId, serviceType, status, price, dueDate, notes };
                    showMessage('Project updated successfully!');
                }
            } else {
                const newProject = {
                    id: crypto.randomUUID(),
                    name,
                    clientId,
                    serviceType,
                    status,
                    price: price ? parseFloat(price) : null,
                    dueDate,
                    notes
                };
                projects.push(newProject);
                showMessage('Project added successfully!');
            }
            saveData();
            renderProjects();
            closeModal('project-modal');
        });

        function editProject(projectId) {
            openProjectModal(projectId);
        }

        function deleteProject(projectId) {
            if (confirm('Are you sure you want to delete this project?')) {
                projects = projects.filter(p => p.id !== projectId);
                saveData();
                renderProjects();
                showMessage('Project deleted successfully!', 'error');
            }
        }

        // --- Proposal Tracking ---

        function renderProposals() {
            const proposalsList = document.getElementById('proposals-list');
            proposalsList.innerHTML = '';

            if (proposals.length === 0) {
                proposalsList.innerHTML = '<p class="text-gray-600" id="no-proposals-message">No proposals added yet. Click "Add New Proposal" to get started!</p>';
                return;
            }

            proposals.forEach(proposal => {
                const client = clients.find(c => c.id === proposal.clientId);
                const clientName = client ? client.name : 'N/A (Client Deleted)';
                const project = projects.find(p => p.id === proposal.projectId);
                const projectName = project ? project.name : 'N/A (Project Deleted)';

                const proposalCard = document.createElement('div');
                proposalCard.className = 'card';
                proposalCard.innerHTML = `
                    <h3 class="font-bold">${proposal.name}</h3>
                    <p class="text-gray-700"><strong>Client:</strong> ${clientName}</p>
                    ${proposal.projectId ? `<p class="text-gray-700"><strong>Project:</strong> ${projectName}</p>` : ''}
                    <p class="text-gray-700"><strong>Status:</strong> <span class="status-badge status-${proposal.status.toLowerCase().replace(' ', '-')}">${proposal.status}</span></p>
                    <p class="text-gray-700"><strong>Proposed Price:</strong> $${proposal.price}</p>
                    ${proposal.dateSent ? `<p class="text-gray-700"><strong>Date Sent:</strong> ${proposal.dateSent}</p>` : ''}
                    ${proposal.link ? `<p class="text-gray-700"><strong>Link:</strong> <a href="${proposal.link}" target="_blank" class="text-blue-600 hover:underline">View Proposal</a></p>` : ''}
                    <div class="actions">
                        <button class="btn-secondary" onclick="editProposal('${proposal.id}')">Edit</button>
                        <button class="btn-danger" onclick="deleteProposal('${proposal.id}')">Delete</button>
                    </div>
                `;
                proposalsList.appendChild(proposalCard);
            });
        }

        function openProposalModal(proposalId = '') {
            const modal = document.getElementById('proposal-modal');
            const form = document.getElementById('proposal-form');
            const title = document.getElementById('proposal-modal-title');
            const proposalIdField = document.getElementById('proposal-id');
            const proposalNameField = document.getElementById('proposal-name');
            const proposalClientField = document.getElementById('proposal-client');
            const proposalProjectField = document.getElementById('proposal-project');
            const proposalStatusField = document.getElementById('proposal-status');
            const proposalDateSentField = document.getElementById('proposal-date-sent');
            const proposalPriceField = document.getElementById('proposal-price');
            const proposalLinkField = document.getElementById('proposal-link');

            form.reset();
            populateClientDropdowns('proposal-client'); // Populate client dropdown
            populateProjectDropdowns('proposal-project'); // Populate project dropdown

            if (proposalId) {
                const proposal = proposals.find(pr => pr.id === proposalId);
                if (proposal) {
                    title.textContent = 'Edit Proposal';
                    proposalIdField.value = proposal.id;
                    proposalNameField.value = proposal.name;
                    proposalClientField.value = proposal.clientId;
                    proposalProjectField.value = proposal.projectId;
                    proposalStatusField.value = proposal.status;
                    proposalDateSentField.value = proposal.dateSent;
                    proposalPriceField.value = proposal.price;
                    proposalLinkField.value = proposal.link;
                }
            } else {
                title.textContent = 'Add New Proposal';
                proposalIdField.value = '';
            }
            openModal('proposal-modal');
        }

        document.getElementById('proposal-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const id = document.getElementById('proposal-id').value;
            const name = document.getElementById('proposal-name').value;
            const clientId = document.getElementById('proposal-client').value;
            const projectId = document.getElementById('proposal-project').value;
            const status = document.getElementById('proposal-status').value;
            const dateSent = document.getElementById('proposal-date-sent').value;
            const price = document.getElementById('proposal-price').value;
            const link = document.getElementById('proposal-link').value;

            if (id) {
                const proposalIndex = proposals.findIndex(pr => pr.id === id);
                if (proposalIndex > -1) {
                    proposals[proposalIndex] = { ...proposals[proposalIndex], name, clientId, projectId, status, dateSent, price: parseFloat(price), link };
                    showMessage('Proposal updated successfully!');
                }
            } else {
                const newProposal = {
                    id: crypto.randomUUID(),
                    name,
                    clientId,
                    projectId: projectId || null, // Store as null if not selected
                    status,
                    dateSent,
                    price: parseFloat(price),
                    link
                };
                proposals.push(newProposal);
                showMessage('Proposal added successfully!');
            }
            saveData();
            renderProposals();
            closeModal('proposal-modal');
        });

        function editProposal(proposalId) {
            openProposalModal(proposalId);
        }

        function deleteProposal(proposalId) {
            if (confirm('Are you sure you want to delete this proposal?')) {
                proposals = proposals.filter(pr => pr.id !== proposalId);
                saveData();
                renderProposals();
                showMessage('Proposal deleted successfully!', 'error');
            }
        }

        // --- Template Management ---

        function renderTemplates() {
            const templatesList = document.getElementById('templates-list');
            templatesList.innerHTML = '';

            if (templates.length === 0) {
                templatesList.innerHTML = '<p class="text-gray-600" id="no-templates-message">No custom templates added yet. Click "Add New Template" to get started!</p>';
                return;
            }

            templates.forEach(template => {
                const templateBox = document.createElement('div');
                templateBox.className = 'template-box';
                templateBox.innerHTML = `
                    <h3>${template.name}</h3>
                    <button class="copy-btn" onclick="copyToClipboard('${template.id}')">Copy</button>
                    <div id="${template.id}" class="whitespace-pre-wrap">${template.content}</div>
                    ${!predefinedTemplates.some(pt => pt.id === template.id) ? `
                        <div class="actions mt-4">
                            <button class="btn-secondary" onclick="editTemplate('${template.id}')">Edit</button>
                            <button class="btn-danger" onclick="deleteTemplate('${template.id}')">Delete</button>
                        </div>
                    ` : ''}
                `;
                templatesList.appendChild(templateBox);
            });
        }

        function openTemplateModal(templateId = '') {
            const modal = document.getElementById('template-modal');
            const form = document.getElementById('template-form');
            const title = document.getElementById('template-modal-title');
            const templateIdField = document.getElementById('template-id');
            const templateNameField = document.getElementById('template-name');
            const templateContentField = document.getElementById('template-content');

            form.reset();

            if (templateId) {
                const template = templates.find(t => t.id === templateId);
                if (template && !predefinedTemplates.some(pt => pt.id === template.id)) { // Only allow editing custom templates
                    title.textContent = 'Edit Template';
                    templateIdField.value = template.id;
                    templateNameField.value = template.name;
                    templateContentField.value = template.content;
                } else if (template) {
                    showMessage('Pre-defined templates cannot be edited.', 'error');
                    return; // Prevent modal from opening for predefined templates
                }
            } else {
                title.textContent = 'Add New Template';
                templateIdField.value = '';
            }
            openModal('template-modal');
        }

        document.getElementById('template-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const id = document.getElementById('template-id').value;
            const name = document.getElementById('template-name').value;
            const content = document.getElementById('template-content').value;

            if (id) {
                const templateIndex = templates.findIndex(t => t.id === id);
                if (templateIndex > -1 && !predefinedTemplates.some(pt => pt.id === id)) {
                    templates[templateIndex] = { ...templates[templateIndex], name, content };
                    showMessage('Template updated successfully!');
                } else {
                    showMessage('Error: Cannot edit predefined template.', 'error');
                }
            } else {
                const newTemplate = {
                    id: crypto.randomUUID(),
                    name,
                    content
                };
                templates.push(newTemplate);
                showMessage('Template added successfully!');
            }
            saveData();
            renderTemplates();
            closeModal('template-modal');
        });

        function editTemplate(templateId) {
            openTemplateModal(templateId);
        }

        function deleteTemplate(templateId) {
            if (predefinedTemplates.some(pt => pt.id === templateId)) {
                showMessage('Pre-defined templates cannot be deleted.', 'error');
                return;
            }
            if (confirm('Are you sure you want to delete this template?')) {
                templates = templates.filter(t => t.id !== templateId);
                saveData();
                renderTemplates();
                showMessage('Template deleted successfully!', 'error');
            }
        }

        // --- Utility Functions ---

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent || element.innerText;

            // Use a temporary textarea to copy text, as navigator.clipboard might not work in some iframe environments
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed'; // Prevent scrolling to bottom
            textarea.style.opacity = 0;
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                document.execCommand('copy');
                const btn = element.parentNode.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.style.background = '#28a745';

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#4F81BD';
                }, 2000);
                showMessage('Content copied to clipboard!');
            } catch (err) {
                showMessage('Failed to copy text. Please try manually.', 'error');
                console.error('Failed to copy: ', err);
            } finally {
                document.body.removeChild(textarea);
            }
        }

        // Initial load and render
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            showSheet('clients'); // Default to clients tab on load
        });

        // Simple confirmation dialog replacement
        function confirm(message) {
            return window.confirm(message); // Using native confirm for simplicity in this single-file app
        }
    </script>
</body>
</html>
